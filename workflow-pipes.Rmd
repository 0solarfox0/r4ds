# Workflow: Pipes {#workflow-pipes}

```{r, results = "asis", echo = FALSE}
status("restructuring")
```

The pipe, `|>`, is a powerful tool for clearly expressing a sequence of operations that transform an object.
We briefly introduced them in the previous chapter but before going too much farther I wanted to give a little more motivation and discuss another pipe that you're likely to see in the wild.

## Why use a pipe?

Because each individual dplyr function is quite simple, solving complex problems typically require multiple verbs together.
For example, the last chapter finished with a moderately complex pipe:

```{r, eval = FALSE}
flights |>  
  filter(!is.na(arr_delay), !is.na(tailnum)) |> 
  group_by(tailnum) |> 
  summarise(
    delay = mean(arr_delay, na.rm = TRUE),
    n = n()
  )
```

Even though this pipe has four steps, because the verbs come at the start of each line, it's quite easy to skim: we start with flights, then filter, then group, then summarize.

What would happen if we didn't have the pipe?
We could nest each function call inside the previous call:

```{r, eval = FALSE}
summarise(
  group_by(
    filter(
      flights, 
      !is.na(arr_delay), !is.na(tailnum)
    ),
    tailnum
  ), 
  delay = mean(arr_delay, na.rm = TRUE
  ), 
  n = n()
)
```

Or we could use a bunch of intermediate variables:

```{r, eval = FALSE}
flights1 <- filter(flights, !is.na(arr_delay), !is.na(tailnum))
flights2 <- group_by(flights1, tailnum) 
flights3 <- summarise(flight2,
  delay = mean(arr_delay, na.rm = TRUE),
  n = n()
)
```

While both of these forms have their place and time, the pipe generally produces code that is easier to read and easier to write.

To add the pipe to your code, we recommend using the build-in keyboard shortcut Ctrl/Cmd + Shift + M.
You'll also need to make one change to your RStudio options to use the base pipe instead of the magrittr pipe as shown in Figure \@ref(fig:pipe-options); more on that next.

```{r pipe-options, out.width = NULL, echo = FALSE}
#| fig.cap: >
#|   To insert `|>`, make sure the "Use native pipe" option is checked.
#| fig.alt: > 
#|   Screenshot showing the "Use native pipe operator" option which can
#|   be found on the "Editing" panel of the "Code" options.
knitr::include_graphics("screenshots/rstudio-pipe-options.png")
```

## magrittr and the `%>%` pipe

If you've been using the tidyverse for a while, you might have been be more familiar with the `%>%` pipe provided by the **magrittr** package by Stefan Milton Bache.
The magrittr package is included in the code the tidyverse, so you can use `%>%` whenever you use the tidyverse:

```{r, message = FALSE}
library(tidyverse)

mtcars %>% 
  group_by(cyl) %>%
  summarise(n = n())
```

For simple cases `|>` and `%>%` behave identically.
So why do we recommend the base pipe?
Firstly, because it's part of base R, it's always available for you to use, even when you're not using the tidyverse.
Secondly, the `|>` is quite a bit simpler than `%>%`: in the 7 years between the invention of `%>%` in 2014 and the inclusion of `|>` in R 4.1.0 in 2021, we better learned what the core strength of the pipe was, allowing the base implementation to jettison infrequently used and less important features.

## Base pipe vs magrittr pipe

While `|>` and `%>%` behave identically for simple cases there are a few important differences.
These are most likely to affect you if you're a long-term `%>%` user who has taken advantage of some of the more advanced features.
But they're good to know about even if you've never used `%>%`, because you're likely to encounter some of them when reading wild-caught code.

-   The pipe requires that object on the left hand side be passed to the first argument of the function on the right-hand side.
    `%>%` allows you change the placement using `.` as a placeholder.
    For example, `x %>% f(1)` is equivalent to `f(x, 1)` but `x %>% f(1, .)` is equivalent to `f(1, x)`.

    R 4.2.0 will bring a `_` as a placeholder, but it has to be named, so you could write `x |> f(1, y = _)`.
    The base placeholder is deliberately simple; you can't pass it to multiple arguments, and it doesn't have the special behavior that `%>%` does when used with `{}`.

    You can also use both `.` and `_` on the left-hand side of operators like `$`, `[[`, `[` (which you'll learn about in Chapter \@ref(vectors)):

    ``` r
    mtcars %>% .$cyl
    mtcars |> _$cyl
    ```

    For the special case of extracting a column out of a data frame, you can also use `dplyr::pull():`

    ```{r}
    mtcars |> pull(cyl)
    ```

-   When calling a function with no argument, `%>%` allowed you to drop the drop the parentheses, and write (e.g.) `x %>% ungroup`.
    `|>` always requires the parentheses.

-   Starting a pipe with `.`, like `. %>% group_by(x) %>% summarise(x)` would create a function rather than immediately performing the pipe.
    This is an error with the base pipe.
